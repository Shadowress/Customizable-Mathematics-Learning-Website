{% extends 'base.html' %}

{% load crispy_forms_tags %}
{% load static %}

{% block title %}Create Course{% endblock %}

{% block css %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="{% static 'css/create_or_edit_course.css' %}">
{% endblock %}

{% block header %}
    {% include 'includes/content_manager_header.html' %}
{% endblock %}

{% block content %}
    <form method="POST" enctype="multipart/form-data">
        {% csrf_token %}
        {{ course_form|crispy }}

        <button type="submit" name="action" value="save_draft">Save Course</button>
        <button type="submit" name="action" value="publish">Publish Course</button>

        {{ section_formset.management_form }}
        {{ text_content_formset.management_form }}
        {{ image_content_formset.management_form }}
        {{ video_content_formset.management_form }}
        {{ quiz_formset.management_form }}

        <div id="sections"></div>

        <div id="global-add-toolbar" class="add-toolbar">
            <button type="button" class="toolbar-btn" id="add-text-btn" title="Add Text">
                <i class="fas fa-font"></i>
            </button>
            <button type="button" class="toolbar-btn" id="add-image-btn" title="Add Image">
                <i class="fas fa-image"></i>
            </button>
            <button type="button" class="toolbar-btn" id="add-video-btn" title="Add Video">
                <i class="fas fa-video"></i>
            </button>
            <button type="button" class="toolbar-btn" id="add-quiz-btn" title="Add Quiz">
                <i class="fas fa-question-circle"></i>
            </button>
            <button type="button" class="toolbar-btn" id="add-section-btn" title="Add Section">
                <i class="fas fa-plus"></i>
            </button>
        </div>
    </form>

    <!-- Hidden template for empty section form -->
    <div id="empty-section-form" style="display: none;">
        <div class="section-form">
            <h3 class="section-title">Section __num__</h3>
            {{ section_formset.empty_form|crispy }}
            <button type="button" class="remove-section btn btn-danger">Remove</button>

            <div class="section-contents">
                <!-- Content Forms will be added here -->
            </div>

            <div class="section-quizzes">
                <!-- Quiz Forms will be added here -->
            </div>
        </div>
    </div>

    <!-- Hidden template for empty text content form -->
    <div id="empty-text-content-form" style="display: none;">
        <div class="text-content-form">
            {{ text_content_formset.empty_form|crispy }}
            <button type="button" class="remove-content btn btn-danger">Remove Content</button>
        </div>
    </div>

    <!-- Hidden template for empty image content form -->
    <div id="empty-image-content-form" style="display: none;">
        <div class="image-content-form">
            {{ image_content_formset.empty_form|crispy }}
            <button type="button" class="remove-content btn btn-danger">Remove Image</button>
        </div>
    </div>

    <!-- Hidden template for empty video content form -->
    <div id="empty-video-content-form" style="display: none;">
        <div class="video-content-form">
            {{ video_content_formset.empty_form|crispy }}
            <button type="button" class="remove-content btn btn-danger">Remove Video</button>
        </div>
    </div>

    <!-- Hidden template for empty quiz form -->
    <div id="empty-quiz-form" style="display: none;">
        <div class="quiz-form">
            {{ quiz_formset.empty_form|crispy }}
            <button type="button" class="remove-quiz btn btn-danger">Remove Quiz</button>
        </div>
    </div>
{% endblock %}

{% block script %}
    <script src="{% static 'js/create_or_edit_course.js' %}"></script>
    <script>
        const getJsonData = (data) => {
            try {
                return JSON.parse(data);
            } catch (e) {
                console.error("Failed to parse JSON data:", e);
                return [];
            }
        };

        const existingSections = getJsonData('{{ existing_sections|default:"[]"|escapejs }}');
        const existingTextContents = getJsonData('{{ existing_text_contents|default:"[]"|escapejs }}');
        const existingImageContents = getJsonData('{{ existing_image_contents|default:"[]"|escapejs }}');
        const existingVideoContents = getJsonData('{{ existing_video_contents|default:"[]"|escapejs }}');
        const existingQuizzes = getJsonData('{{ existing_quizzes|default:"[]"|escapejs }}');
    </script>
{% endblock %}
